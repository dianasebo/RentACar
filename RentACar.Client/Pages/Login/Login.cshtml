@page "/login"
@using RentACar.Shared.Models
@inject HttpClient Http
@inject Microsoft.AspNetCore.Blazor.Services.IUriHelper UriHelper
@inject Blazor.Extensions.Storage.SessionStorage SessionStorage

<div class="field-container centered-content">
    <div class="form-group">
        <label for="email" class="control-label">Email: </label>
        <input required for="email" bind="@loginRequest.Email" type="email" class="form-control" />
    </div>

    <div class="form-group">
        <label for="password" class="control-label">Password: </label>
        <input required for="password" bind="@loginRequest.Password" type="password" class="form-control" />
    </div>

    @if (!CorrectInfo)
    {
        <div class="error"><em>Email or password wrong</em></div>
    }

    <div class="form-group">
        <button type="submit" class="btn btn-default" onclick="@AttemptLogin">Login</button>
    </div>
</div>

@functions
{
    LoginRequest loginRequest { get; set; } = new LoginRequest();
    bool CorrectInfo { get; set; } = true;
    protected async void AttemptLogin()
    {
        var response = await Http.PostJsonAsync<LoginResponse>("api/Login", loginRequest);

        if (response.IsSuccessful)
        {
            var tokenKey = "token";
            var tokenValue = response.Token;
            await SessionStorage.SetItem(tokenKey, tokenValue);

            var isUserLoggedIn = "isUserLoggedIn";
            await SessionStorage.SetItem<bool>(isUserLoggedIn, true);
            UriHelper.NavigateTo("/");
        }
        else
        {
            CorrectInfo = false;
            this.StateHasChanged();
        }
    }
}